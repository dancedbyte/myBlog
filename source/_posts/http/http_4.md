---
title: HTTPS 协议总结
tags: HTTPS
categories: 网络协议
date: 2020-10-26
index_img: /img/http_4_1.jpg
---

## HTTPS 介绍

### 定义
1. 全称是超文本传输安全协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。

2. HTTPS 主要是提供一种对服务器安全性进行校验的功能，保证数据传输的隐私与可靠性。

    <img src='/img/http_1_2.png' width='240' />

3. 可以看出 HTTPS 只是在 HTTP 的基础上加了 SSL/TLS 安全层，它属于一个模块嵌入到http协议中。

4. http默认端口80。https默认端口443。

### 作用
1. 数据加密传输，保证了数据的隐私性、安全性。

2. 能够校验身份信息，一旦证书或数据被篡改，通信双方会立刻知道。

3. 配备数字证书，防止身份信息被更改。

## 证书有效性验证
打开使用 https 协议的网站，可发现网址开头有一个小锁，点开小锁会有一个证书，那么浏览器是如何验证这个证书有效性的呢？

我们都知道 HTTPS 搭配使用对称加密算法与非对称加密算法，为什么不能只使用其中的一种呢？又是如何搭配使用的呢？一点点来分析。

### 对称加密
不安全。通信双方使用同一个 key 进行加解密。比如客户端和服务端都用同一个 key 把想要传输的数据进行加密。对方收到数据之后，同样用这个 key 进行解密。

>   对称加密的问题：如何让客户端和服务端都知道这个 key ？

    通过下面的 HTTPS 整体流程分析，可以发现是通过非对称加密进行秘钥（即我们说的 key）协商，协商好后双方便能知道这个 key。    

### 非对称加密
较安全。但加解密速度比对称加密慢很多。

服务端和客户端**各自生成一对公钥私钥，且总是成对出现**。如果用共钥进行加密，那么只能用私钥进行解密，调过来如果用私钥加密，只能用共钥才能解密。过程如下：

① 如 A 向 B 发送信息，A 和 B 都要产生一对公钥和私钥。A 的私钥自己保密，A 的公钥告诉 B；B 的私钥自己保密，B 的公钥告诉 A。

② A 用 B 的公钥加密信息。所以 B 收到消息后可以用自己的私钥来解密数据。

③ 哪怕中间有人拿到了加密信息，也无所谓，因为只有 B 才有私钥去加密。

>   为什么非对称加密比对称加密慢很多？

    ① 对称加密：主要的运算是位运算，速度非常快，以 AES 算法为例，其运算本质上就是位移和替换。如果使用硬件计算，速度会更快。
    ② 非对称加密：上面我们说 A 和 B 需要将自己的公钥告诉对方，这一过程使用的是 Diffie-Hellman 算法（利用数学中大数乘法、大数取模）。
       增加被破解的难度，增加想要破解所消耗的时间。具体算法如下：
       
       1. Alice与Bob确定两个大素数n和g，这两个数不用保密。
       2. Alice选择另一个大随机数x（需保密，只能有自己知道），计算余数A：A = gx mod n
       3. Alice将A发给Bob 
       4. Bob选择另一个大随机数y（需保密，只能有自己知道），计算余数B：B = gy mod n
       5. Bob将B发给Alice
       6. 计算秘密密钥K1如下:K1 = Bx mod n
       7. 计算秘密密钥K2如下:K2 = Ay mod n 
       8. 若K1 = K2，因此Alice和Bob可以用其进行加解密

### 非对称加密 + 对称加密
因为非对称很慢，所以我们可以用非对称去获取这个很重要的 key，以后的数据传输使用这个 key 作为对称加密的秘钥。

**但是这还是会有一个问题**：没有校验服务器的真实性，如果在非对称加密阶段，我们和一个中间人服务器进行了秘钥协商获取了 key，那么之后的所有加密数据都可以被中间人很轻松的破解。

### 非对称加密 + 对称加密 + CA 证书
为了解决上面说的问题，引入了 CA 签发机构的证书。将我们的服务器在权威机构进行认证，认证成功之后，认证机构就会给我们发送 CA 证书，然后服务器的每一次响应都带上该证书，客户端就能够识别服务器是否合法（因为客户端操作系统都内置了识别证书的功能）。

>   证书签发机构流程：

    ① 服务器 example.com（必须有域名）将从CA（如Digicert）请求TLS证书。  
    ② Digicert将为example.com创建证书，证书将包含必要的数据，如服务器名称，服务器的公钥等。

如果验证成功，则服务器合法，是可以正常发送数据的。**那么服务器响应时携带的证书一定是 CA 颁发的那个吗？有没有可能被中间人修改了证书中的内容**。

>   则需要进行证书合法性验证！服务端使用 Hash 算法及 CA 私钥进行签名生成数字证书，在客户端采用同样的 Hash 算法及 CA 公钥解密进行验证。

#### 服务端生成数字证书

    ① 将证书中给定的服务器公钥进行 hash 算法，生成信息摘要， 再将信息摘要通过 CA 证书的私钥加密生成数字签名。
    ② 服务器的公钥 + 上一步生成的数字签名，组成数字证书发送给客户端。

<img src='/img/http_4_2.png' width='340' />    
    

#### 客户端验证数字证书

    ① 对数字证书中的数字签名及服务器公钥分别解密。
    ② 如果两次生成的信息摘要一致，则证书验证成功，服务器合法。
    ③ 如果有中间人对证书进行修改，最后生成的信息摘要就一定不一致，客户端就知道请求被攻击了。

<img src='/img/http_4_3.png' width='340' />

## HTTPS 整体流程分析

<img src='/img/http_4_4.png' width='500' style="margin-bottom: 15px" />

>   可发现 HTTPS 流程主要分为两部分：秘钥协商包括证书验证（非对称加密）、数据传输（对称加密）

1. TCP 三次握手成功之后（因为建立 TCP 数据传输的基础），正式开始 TLS 协议。

2. 客户端首先发送报文开始 TLS 通信，报文中包含客户端支持的 TLS 版本、**随机数Random1**、**加密算法**等。

3. 服务器上需有安装好的认证证书（证书的公钥和私钥是 CA 机构根据服务器的公钥来生成的）。 

4. 服务端**确认并记住**刚才客户端发过来的加密算法。[服务端生成数字证书](https://www.ghmwin.com/2020/10/26/网络协议/http_4/服务端生成数字证书)（数字签名 + 服务器公钥）、**一个随机数Random2**。发送给客户端。

5. [客户端验证证书](https://www.ghmwin.com/2020/10/26/网络协议/http_4/客户端验证数字证书)（使用 hash 解密 + CA 私钥解密）。如果两段信息摘要一致，则验证成功并生成一个**随机数Random3**。否则验证失败拒绝请求。

6. 客户端使用**证书公钥将随机数Random3**加密后传给服务端。

7. 服务端使用**证书私钥**将信息解密，获得**随机数Random3**。到这第 7 步为止，客户端和服务端**都能知道这三个随机数**。

8. 服务端根据第 2 步收到的、与客户端协商好的加密算法对这三个随机数加密生成**对话秘钥（这个秘钥是数据传输阶段对称加密使用的 key）**。

9. 客户端因为也掌握了这三个随机数和加密算法，便也可以生成第 7 步中的对话秘钥。

10. **至此秘钥协商阶段完成**，接下来便是使用对称加密（上面得到的对话秘钥）进行数据传输。 

## 随笔

>   为什么数据传输阶段使用的是对称加密？

    ① 非对称加密的加解密效率是非常低的，而传输过程中涉及到大量的端与端之间的交互，非对称加密的效率是无法接受的。
    ② 在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以 HTTPS 中内容传输加密采取的是对称加密，而不是非对称加密。
    
>   使用 HTTPS 会被抓包吗？

    会被抓包，HTTPS 只是防止用户在不知情的情况下通信被监听，如果用户主动授权，通过代理软件是可以对传输内容进行解密的。

## 参考链接
- [HTTPS 原理分析——带着疑问层层深入](https://www.cnblogs.com/leap/p/11953836.html)
- [HTTPS 协议总结](https://lmjben.github.io/blog/osi-https.html#https-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90)
